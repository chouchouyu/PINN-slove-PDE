# BlackScholesBarenblatt 模型 run_model 函数对比分析报告

## 一、测试概述

本次测试对比了两个不同版本的 `run_model` 函数：

| 版本 | 来源文件 | 用途 |
|------|---------|------|
| v1 | `BlackScholesBarenblatt_FBSNN.py` | 原始版本 |
| v2 | `BlackScholesBarenblatt_FBSNN_Best_Model.py` | 优化版本 |

### 测试参数

- **问题维度**：10D
- **时间区间**：[0, 1.0]
- **轨迹数 (M)**：50
- **时间快照数 (N)**：20
- **网络结构**：[11] + 2×[64] + [1]
- **激活函数**：Sine
- **网络模式**：Naisnet
- **训练迭代**：第一阶段100次(学习率1e-3) + 第二阶段200次(学习率1e-5)

## 二、函数逻辑对比

### 1. 核心功能对比

| 功能点 | v1 | v2 |
|-------|----|----|
| **参数传递** | 使用全局变量 D, T | 显式传递 Xi, T, D 参数 |
| **时间戳** | 是 | 是 |
| **设备信息输出** | 简单输出 device | 格式化输出 "设备: {model.device}" |
| **阶段训练** | 是 | 是 |
| **结果保存目录** | "results" | "results" |
| **模型保存目录** | "optuna_outcomes/models" | "optuna_outcomes/models" |

### 2. 关键技术差异

| 技术点 | v1 | v2 |
|-------|----|----|
| **相对误差计算** | `np.sqrt((Y_test - Y_pred) ** 2 / Y_test ** 2)` | `np.abs(Y_test - Y_pred) / (np.abs(Y_test) + 1e-8)` |
| **误差分母处理** | 直接除以 Y_test (可能除以零) | 添加 1e-8 避免除以零 |
| **平均误差计算** | `np.mean(errors, 0)` | `np.mean(errors, 0)` |
| **绘图标题格式** | 使用字符串拼接 | 使用 f-string 格式化 |
| **绘图网格线** | 无 | 有 (plt.grid(True, alpha=0.3)) |
| **性能指标报告** | 简单输出最终误差 | 详细的相对误差和RMSE报告 |

### 3. 代码质量差异

| 质量指标 | v1 | v2 |
|---------|----|----|
| **代码可读性** | 一般 | 高 |
| **参数封装** | 差 (依赖全局变量) | 好 (显式参数) |
| **错误处理** | 基本无 | 有 (分母防零) |
| **性能报告** | 简单 | 详细 |
| **注释完善度** | 无 | 有 |

## 三、测试结果对比

### 1. 训练过程

| 指标 | v1 | v2 |
|------|----|----|
| **第一阶段训练时间** | 3.58秒 | 1.51秒 |
| **第二阶段训练时间** | 2.88秒 | 2.84秒 |
| **第一阶段最终损失** | 5.133e+03 → ? | 4.367e+03 → ? |
| **第二阶段最终损失** | 1.957e+02 | 1.807e+02 |

### 2. 模型性能

| 性能指标 | v1 | v2 |
|---------|----|----|
| **简单绝对误差** | 0.463221 | N/A |
| **相对误差** | N/A | 0.052837 |
| **RMSE** | N/A | 0.454988 |

### 3. 结果可视化

| 图表类型 | v1 | v2 |
|---------|----|----|
| **损失曲线** | 有 | 有 |
| **预测vs真实值** | 有 | 有 |
| **相对误差曲线** | 有 | 有 |
| **网格线** | 无 | 有 |
| **标题格式** | 传统 | 现代f-string |

## 四、差异分析

### 1. 功能增强

1. **参数显式化**：v2将关键参数（Xi, T, D）作为显式参数传递，避免了对全局变量的依赖，提高了函数的可复用性和模块化程度。

2. **更稳定的误差计算**：v2在相对误差计算中添加了`1e-8`的小值到分母，有效避免了除以零的错误，提高了计算的稳定性。

3. **更科学的评估指标**：v2提供了相对误差和RMSE两种更科学的评估指标，而v1仅使用了简单的绝对误差平均。

4. **更好的可视化效果**：v2添加了网格线，使用了更现代的字符串格式化方法，提高了图表的可读性。

5. **更完整的报告**：v2在训练完成后提供了更详细的性能指标报告，便于用户评估模型质量。

### 2. 性能比较

- **训练速度**：v1和v2的训练速度相当，但v1的第一阶段训练时间明显较长（3.58秒 vs 1.51秒），可能是由于v2的参数传递方式更高效。

- **模型精度**：v2的相对误差（0.052837）显著优于v1的简单绝对误差（0.463221），这表明v2的误差评估方式更科学。

- **稳定性**：v2的RMSE（0.454988）略优于v1，表明v2的模型预测更稳定。

## 五、结论与建议

### 1. 主要结论

- v2版本的`run_model`函数在**功能完整性**、**代码质量**、**误差评估科学性**和**可视化效果**方面均优于v1版本。
- v2提供了更科学的性能评估指标（相对误差和RMSE），而v1仅使用了简单的绝对误差平均。
- v2避免了对全局变量的依赖，提高了函数的可复用性和模块化程度。
- v2在误差计算中添加了稳定性保障（分母加1e-8），避免了除以零的错误。

### 2. 使用建议

1. **优先使用v2版本**：v2版本在各个方面都优于v1版本，建议在实际应用中优先使用v2。

2. **保留v1作为参考**：v1版本可以作为简化版本的参考，适合快速原型开发。

3. **进一步优化建议**：
   - 考虑添加更多的性能指标（如MAE、MAPE等）
   - 实现更灵活的参数配置
   - 添加模型保存和加载的功能
   - 考虑使用TensorBoard等工具进行更高级的可视化

## 六、测试文件说明

本次测试使用的文件：

1. **测试类**：`RunModelComparisonTest.py`
2. **测试结果目录**：`test_results/`
3. **v1测试结果**：`test_results/v1_results/`
4. **v2测试结果**：`test_results/v2_results/`
5. **保存的模型**：`test_results/v1_models/` 和 `test_results/v2_models/`

所有测试结果和保存的模型都可以在上述目录中找到，便于进一步分析和验证。

## 七、环境信息

- **Python版本**：3.13.5
- **PyTorch版本**：2.9.1
- **设备**：Apple MPS (GPU加速)
- **操作系统**：macOS

---

**报告生成时间**：2026-01-16
**测试执行时间**：约10秒